<!DOCTYPE html>
<html>
<head>
    <title>Visualizador IFC - PGE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- USAR VERS√ÉO COMPAT√çVEL COM SCRIPTS TRADICIONAIS -->
    <script src="https://cdn.jsdelivr.net/npm/web-ifc@0.0.42/web-ifc-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.118/dist/web-ifc-three.js"></script>
    
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #info { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            color: white; 
            font-family: Arial; 
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
        }
        #back { 
            position: absolute; 
            top: 10px; 
            right: 10px; 
            color: white; 
            background: #007bff;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            z-index: 1000;
        }
        #progress {
            width: 200px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <a id="back" href="index.html">‚Üê Voltar para In√≠cio</a>
    <div id="info">
        <div>üèóÔ∏è Visualizador IFC PGE</div>
        <div id="status">Inicializando...</div>
        <div id="progress">
            <div id="progress-bar"></div>
        </div>
        <div id="details" style="font-size: 12px; color: #ccc; margin-top: 10px;"></div>
    </div>

    <script>
        // Verificar se as bibliotecas carregaram corretamente
        console.log('Three.js:', typeof THREE);
        console.log('WebIFC:', typeof WebIFC);
        console.log('WebIFCThree:', typeof WebIFCThree);
        
        // Elementos UI
        const statusElement = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const detailsElement = document.getElementById('details');
        
        // Configura√ß√£o Three.js
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        // Luzes
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        scene.add(directionalLight);
        
        // Controles
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // Fun√ß√£o para atualizar status
        function updateStatus(message, progress) {
            statusElement.textContent = message;
            progressBar.style.width = progress + '%';
        }
        
        // Carregar IFC
        async function loadIFC() {
            try {
                // Verificar se WebIFC est√° dispon√≠vel
                if (typeof WebIFC === 'undefined') {
                    throw new Error('WebIFC n√£o carregou corretamente');
                }
                
                updateStatus('üöÄ Inicializando IFC.js...', 10);
                
                const ifcAPI = new WebIFC.IfcAPI();
                await ifcAPI.Init();
                
                updateStatus('üì¶ Configurando loader...', 30);
                
                // Verificar se WebIFCThree est√° dispon√≠vel
                if (typeof WebIFCThree === 'undefined') {
                    throw new Error('WebIFCThree n√£o carregou corretamente');
                }
                
                const ifcLoader = new WebIFCThree.IfcLoader();
                ifcLoader.ifcManager.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.42/");
                
                updateStatus('üîó Conectando com arquivo IFC...', 50);
                
                // URL do arquivo IFC
                const modelURL = '/public/IFC-ELE-SEINF-PGE.ifc';
                detailsElement.textContent = `Arquivo: ${modelURL}`;
                
                updateStatus('üì• Baixando modelo...', 70);
                
                const model = await ifcLoader.load(modelURL);
                scene.add(model);
                
                updateStatus('üéØ Ajustando visualiza√ß√£o...', 90);
                
                // Ajustar c√¢mera para o modelo
                const bbox = new THREE.Box3().setFromObject(model);
                const center = bbox.getCenter(new THREE.Vector3());
                const size = bbox.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                
                camera.position.copy(center);
                camera.position.z += maxDim * 1.5;
                controls.target.copy(center);
                controls.update();
                
                updateStatus('‚úÖ IFC Carregado com Sucesso!', 100);
                
                // Ocultar informa√ß√µes ap√≥s alguns segundos
                setTimeout(() => {
                    document.getElementById('info').style.opacity = '0.3';
                }, 5000);
                
            } catch (error) {
                console.error('Erro ao carregar IFC:', error);
                updateStatus('‚ùå Erro ao carregar IFC', 0);
                detailsElement.innerHTML = `Erro: ${error.message}<br>
                                           Three.js: ${typeof THREE}<br>
                                           WebIFC: ${typeof WebIFC}<br>
                                           WebIFCThree: ${typeof WebIFCThree}`;
            }
        }
        
        // Anima√ß√£o
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Redimensionamento
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Aguardar as bibliotecas carregarem
        function checkLibrariesLoaded() {
            if (typeof THREE !== 'undefined' && 
                typeof WebIFC !== 'undefined' && 
                typeof WebIFCThree !== 'undefined') {
                
                updateStatus('‚úÖ Bibliotecas carregadas', 5);
                setTimeout(() => {
                    loadIFC();
                    animate();
                }, 1000);
                
            } else {
                setTimeout(checkLibrariesLoaded, 100);
            }
        }
        
        // Iniciar verifica√ß√£o
        checkLibrariesLoaded();
    </script>
</body>
</html>

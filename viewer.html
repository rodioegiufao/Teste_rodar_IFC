<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador IFC - PGE</title>
  
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      background: #1e1e1e;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    
    #viewer-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
      background: rgba(0,0,0,0.8);
      padding: 30px;
      border-radius: 10px;
      z-index: 1000;
    }
    
    #back {
      position: absolute;
      top: 15px;
      left: 15px;
      color: white;
      background: #007bff;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none;
      z-index: 1000;
    }
    
    .progress-bar {
      width: 300px;
      height: 10px;
      background: #333;
      border-radius: 5px;
      margin: 15px auto;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: #007bff;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <a id="back" href="index.html">‚Üê Voltar</a>
  
  <div id="viewer-container">
    <div id="loading">
      <h3>üèóÔ∏è Visualizador IFC PGE</h3>
      <div id="status">Inicializando...</div>
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
      <div id="details" style="color: #ccc; font-size: 14px;"></div>
    </div>
  </div>

  <!-- CARREGAMENTO CORRETO DAS BIBLIOTECAS -->
  <script src="https://cdn.jsdelivr.net/npm/web-ifc@0.0.34/webifc.wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.117/dist/web-ifc-three.browser.js"></script>
  
  <!-- USAR O MESMO M√âTODO DO C√ìDIGO FUNCIONAL: bundle.js personalizado -->
  <script>
    // ===== CONFIGURA√á√ÉO ID√äNTICA AO C√ìDIGO FUNCIONAL =====
    
    // Elementos da UI
    const statusElement = document.getElementById('status');
    const progressElement = document.getElementById('progress');
    const detailsElement = document.getElementById('details');
    const loadingElement = document.getElementById('loading');
    
    // Atualizar status (igual ao c√≥digo funcional)
    function updateStatus(message, percent = 0) {
      statusElement.textContent = message;
      progressElement.style.width = percent + '%';
      console.log('Status:', message, percent + '%');
    }
    
    // Carregar bibliotecas IFC de forma robusta
    function loadIFCLibraries() {
      return new Promise((resolve, reject) => {
        updateStatus('Carregando bibliotecas IFC...', 10);
        
        // M√©todo do c√≥digo funcional: carregar vers√µes espec√≠ficas
        const scripts = [
          'https://cdn.jsdelivr.net/npm/web-ifc@0.0.39/web-ifc-api.js',
          'https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.117/dist/web-ifc-three.js'
        ];
        
        let loaded = 0;
        
        scripts.forEach((src, index) => {
          const script = document.createElement('script');
          script.src = src;
          
          script.onload = () => {
            loaded++;
            updateStatus(`Biblioteca ${index + 1}/${scripts.length} carregada`, 10 + (index + 1) * 30);
            
            if (loaded === scripts.length) {
              // Verificar se as bibliotecas carregaram corretamente
              if (typeof WebIFC !== 'undefined' && typeof WebIFCThree !== 'undefined') {
                updateStatus('Bibliotecas IFC carregadas com sucesso', 70);
                resolve();
              } else {
                reject(new Error('Bibliotecas IFC n√£o inicializadas corretamente'));
              }
            }
          };
          
          script.onerror = () => {
            reject(new Error(`Falha ao carregar: ${src}`));
          };
          
          document.head.appendChild(script);
        });
      });
    }
    
    // Inicializar o visualizador (igual ao c√≥digo funcional)
    async function initViewer() {
      try {
        updateStatus('Inicializando Three.js...', 5);
        // Adicione antes do seu c√≥digo Three.js
        window.addEventListener('error', function(e) {
            console.error('Erro global capturado:', e.error);
        });
        
        // Verifique se as bibliotecas carregaram corretamente
        function checkLibraries() {
            if (typeof WebIFC === 'undefined') {
                console.error('WebIFC n√£o carregou');
                return false;
            }
            if (typeof WebIFCThree === 'undefined') {
                console.error('WebIFCThree n√£o carregou');
                return false;
            }
            return true;
        }
        
        // Aguarde o carregamento completo
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!checkLibraries()) {
                    console.log('Tentando carregar fallback...');
                    // C√≥digo de fallback aqui
                }
            }, 1000);
        });
        // Configura√ß√£o Three.js
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x2a2a2a);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('viewer-container').appendChild(renderer.domElement);
        
        // Luzes (configura√ß√£o profissional igual ao c√≥digo funcional)
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        scene.add(directionalLight);
        
        // Controles
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        updateStatus('Carregando bibliotecas IFC...', 20);
        
        // Carregar bibliotecas IFC
        await loadIFCLibraries();
        
        updateStatus('Configurando loader IFC...', 80);
        
        // Configurar IFC Loader (igual ao c√≥digo funcional)
        const ifcAPI = new WebIFC.IfcAPI();
        await ifcAPI.Init();
        
        const ifcLoader = new WebIFCThree.IfcLoader();
        ifcLoader.ifcManager.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.39/");
        
        updateStatus('Carregando modelo IFC...', 90);
        
        // Carregar o arquivo IFC
        const modelURL = '/public/IFC-ELE-SEINF-PGE.ifc';
        detailsElement.textContent = `Arquivo: ${modelURL}`;
        
        const model = await ifcLoader.load(modelURL);
        scene.add(model);
        
        updateStatus('Ajustando visualiza√ß√£o...', 95);
        
        // Ajustar c√¢mera (m√©todo profissional)
        const box = new THREE.Box3().setFromObject(model);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        
        camera.position.copy(center);
        camera.position.z += maxDim * 1.5;
        controls.target.copy(center);
        controls.update();
        
        updateStatus('IFC Carregado com Sucesso!', 100);
        
        // Ocultar loading ap√≥s 2 segundos (como no c√≥digo funcional)
        setTimeout(() => {
          loadingElement.style.opacity = '0.3';
          loadingElement.style.transition = 'opacity 1s';
        }, 2000);
        
        // Anima√ß√£o (loop principal)
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();
        
        // Redimensionamento
        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        console.log('‚úÖ Visualizador IFC inicializado com sucesso!');
        
      } catch (error) {
        console.error('‚ùå Erro no visualizador:', error);
        updateStatus('Erro ao carregar visualizador', 0);
        detailsElement.innerHTML = `
          <div style="color: #ff6b6b; margin-top: 10px;">
            <strong>Erro:</strong> ${error.message}
          </div>
          <div style="margin-top: 10px; font-size: 12px;">
            Verifique o console (F12) para detalhes
          </div>
        `;
      }
    }
    
    // Iniciar quando a p√°gina carregar
    window.addEventListener('load', initViewer);
  </script>
</body>
</html>

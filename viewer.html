<!DOCTYPE html>
<html>
<head>
    <title>Visualizador IFC - PGE</title>
    
    <!-- Three.js B√°sico -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000;
            overflow: hidden;
        }
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            font-size: 18px;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 10px;
            z-index: 1000;
        }
        #back {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            background: #007bff;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <a id="back" href="index.html">‚Üê Voltar</a>
    <div id="container">
        <div id="loading">
            <div>üèóÔ∏è Visualizador IFC PGE</div>
            <div id="status">Inicializando...</div>
            <div id="progress" style="margin: 15px 0; color: #ccc; font-size: 14px;"></div>
        </div>
    </div>

    <script>
        // Elementos da UI
        const statusElement = document.getElementById('status');
        const progressElement = document.getElementById('progress');
        const loadingElement = document.getElementById('loading');
        
        // Configura√ß√£o b√°sica do Three.js (sempre funciona)
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 5, 5);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);
        
        // Luzes b√°sicas
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 5);
        scene.add(directionalLight);
        
        // Controles
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // Fun√ß√£o para atualizar status
        function updateStatus(message, progress = '') {
            statusElement.textContent = message;
            progressElement.textContent = progress;
            console.log('Status:', message);
        }
        
        // Carregar bibliotecas IFC de forma SEGURA
        function loadIFCLibraries() {
            return new Promise((resolve, reject) => {
                updateStatus('üì¶ Carregando bibliotecas IFC...');
                
                // Verificar se j√° existem (evitar duplicar)
                if (window.WebIFC && window.WebIFCThree) {
                    resolve();
                    return;
                }
                
                // Carregar web-ifc-api.js (vers√£o compat√≠vel)
                const script1 = document.createElement('script');
                script1.src = 'https://cdn.jsdelivr.net/npm/web-ifc@0.0.39/web-ifc-api.js';
                
                script1.onload = function() {
                    updateStatus('‚úÖ WebIFC carregado', 'Carregando WebIFCThree...');
                    
                    // Carregar web-ifc-three.js (vers√£o compat√≠vel)
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.117/dist/web-ifc-three.js';
                    
                    script2.onload = function() {
                        updateStatus('‚úÖ Bibliotecas prontas', 'Inicializando IFC.js...');
                        resolve();
                    };
                    
                    script2.onerror = function() {
                        reject(new Error('Falha ao carregar WebIFCThree'));
                    };
                    
                    document.head.appendChild(script2);
                };
                
                script1.onerror = function() {
                    reject(new Error('Falha ao carregar WebIFC'));
                };
                
                document.head.appendChild(script1);
            });
        }
        
        // Carregar modelo IFC
        async function loadIFCModel() {
            try {
                updateStatus('üöÄ Inicializando IFC.js...');
                
                // Verificar se as bibliotecas carregaram
                if (typeof WebIFC === 'undefined') {
                    throw new Error('WebIFC n√£o dispon√≠vel');
                }
                
                const ifcAPI = new WebIFC.IfcAPI();
                await ifcAPI.Init();
                
                updateStatus('üîß Configurando loader...');
                
                if (typeof WebIFCThree === 'undefined') {
                    throw new Error('WebIFCThree n√£o dispon√≠vel');
                }
                
                const ifcLoader = new WebIFCThree.IfcLoader();
                
                // Configurar caminho do WASM (IMPORTANTE)
                ifcLoader.ifcManager.setWasmPath("https://cdn.jsdelivr.net/npm/web-ifc@0.0.39/");
                ifcLoader.setupIfcLoader(ifcAPI, scene);
                
                updateStatus('üì• Baixando arquivo IFC...', 'public/IFC-ELE-SEINF-PGE.ifc');
                
                // Carregar o modelo
                const modelURL = '/IFC-ELE-SEINF-PGE.ifc';
                const model = await ifcLoader.load(modelURL);
                
                updateStatus('üéØ Ajustando visualiza√ß√£o...');
                
                // Ajustar c√¢mera
                const bbox = new THREE.Box3().setFromObject(model);
                const center = bbox.getCenter(new THREE.Vector3());
                const size = bbox.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                
                camera.position.copy(center);
                camera.position.z += maxDim * 1.5;
                controls.target.copy(center);
                controls.update();
                
                updateStatus('‚úÖ IFC Carregado com Sucesso!', `${Math.round(size.x)}x${Math.round(size.y)}x${Math.round(size.z)}`);
                
                // Ocultar loading ap√≥s 3 segundos
                setTimeout(() => {
                    loadingElement.style.opacity = '0.3';
                    loadingElement.style.transition = 'opacity 1s';
                }, 3000);
                
            } catch (error) {
                console.error('Erro detalhado:', error);
                updateStatus('‚ùå Erro ao carregar IFC', 'Mostrando fallback...');
                showFallbackModel(error.message);
            }
        }
        
        // Fallback: mostrar um modelo 3D simples
        function showFallbackModel(errorMsg) {
            // Criar um objeto 3D simples para demonstrar que o Three.js funciona
            const geometry = new THREE.BoxGeometry(2, 2, 2);
            const material = new THREE.MeshPhongMaterial({ color: 0xff0000 });
            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);
            
            camera.position.z = 5;
            controls.update();
            
            progressElement.innerHTML = `Erro: ${errorMsg}<br>Three.js est√° funcionando (cubo vermelho)`;
        }
        
        // Anima√ß√£o
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Redimensionamento
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // Inicializa√ß√£o principal
        async function init() {
            try {
                updateStatus('‚úÖ Three.js carregado', 'Preparando visualizador...');
                
                // Aguardar um pouco para garantir que tudo est√° pronto
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Carregar bibliotecas IFC
                await loadIFCLibraries();
                
                // Carregar modelo IFC
                await loadIFCModel();
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                updateStatus('‚ùå Falha na inicializa√ß√£o', 'Usando modo fallback...');
                showFallbackModel(error.message);
            }
            
            // Iniciar anima√ß√£o
            animate();
        }
        
        // Iniciar quando a p√°gina carregar
        window.addEventListener('load', init);
    </script>
</body>
</html>
